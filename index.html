<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1e293b" />
  <title>Malla Curricular – Trabajo Social</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    :root{
      --bg-overlay: rgba(0,0,0,.30);
      --muted: #94a3b8;
      --accent: #2563eb;
      --ok: #10b981;
      --tag-general: #314559;       /* menta/teal */
      --tag-licenciatura: #ff6fa0;  /* rosa */
      --tag-especialidad: #56c6ad;  /* azul profundo */
      --blocked: #cbd5e1;
      --year1: #06b6d4;
      --year2: #8b5cf6;
      --year3: #f97316;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      max-width: 100vw; overflow-x: hidden;
      height: 100%; color: #e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      background: #0b1220;
    }
    body::before{ content:""; position: fixed; inset:0; z-index:-2;
      background: url('assets/bg-default.png') center/cover no-repeat fixed;
    }
    body::after{ content:""; position: fixed; inset:0; z-index:-1; background: var(--bg-overlay); }
    header { padding: calc(env(safe-area-inset-top) + 16px) 16px 8px; text-align: center; }
    h1 { margin: 0 0 6px; font-weight: 800; font-size: clamp(22px, 4vw, 36px); }
    .subtitle { margin:0 auto 14px; max-width: 900px; color: #cbd5e1; font-size: clamp(13px, 2.3vw, 16px); }
    .toolbar { display:flex; justify-content:center; gap:8px; flex-wrap: wrap; padding: 6px 12px 0; margin-bottom: 8px; }
    button, .btn {
      
      cursor: pointer; background:#ffffff; color:#0b1220; border:none; border-radius:14px; padding:12px 14px;
      font-weight: 700; min-height: 44px; min-width: 44px; box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }
    button:focus-visible { outline: 3px solid #93c5fd; outline-offset: 2px; }
    .menu { position:relative; }
    .menu-panel { position:absolute; right:0; top:calc(100% + 8px);
      background: #0f172a; border:1px solid #334155; border-radius: 14px; padding:8px; min-width: 280px;
      display:none; box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .menu.open .menu-panel { display:block; }
    .menu-item { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; color:#e5e7eb; }
    .menu-item:hover { background:#111827; }
    .switch { position: relative; width: 54px; height: 30px; background:#1f2937; border-radius: 999px; border:1px solid #374151; }
    .switch input{ display:none; }
    .switch .knob { position:absolute; top:2px; left:2px; width:26px; height:26px; border-radius:50%; background:#9ca3af; transition: all .2s ease; }
    .switch input:checked + .knob { left:26px; background:#34d399; }
    main { padding: 8px 14px calc(env(safe-area-inset-bottom) + 24px); max-width: 1400px; margin: 0 auto; }

    details.legend { background: rgba(15,23,42,.7); border:1px solid #334155; border-radius: 14px; padding: 10px 12px; margin-bottom: 12px; }
    details.legend summary{ cursor: pointer; font-weight:800; }
    .legend-pill { display:inline-flex; align-items:center; gap:8px; margin-right:12px; font-size: 14px; }
    .pill { display:inline-block; padding:6px 12px; border-radius: 999px; font-weight: 800; color:#0b1220; }
    .pill.general{ background: var(--tag-general); }
    .pill.licenciatura{ background: var(--tag-licenciatura); color:#fff; }
    .pill.especialidad{ background: var(--tag-especialidad); color:#fff; }

    /* Column layout for trimestres */
    .year-block { margin: 18px 0; }
    .year-title{ font-weight:900; margin: 4px 0 10px; color:#e5e7eb; text-transform: uppercase; letter-spacing: .08em; }
    .tri-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:14px; }
    .tri-col { background: rgba(15,23,42,.7); border:1px solid #334155; border-radius: 16px; padding: 12px; }
    .tri-head { font-weight:800; color:#cbd5e1; margin-bottom: 10px; text-transform: uppercase; font-size: 14px; letter-spacing: .06em; }

    .course {
      position: relative; border-radius: 12px; padding: 12px; margin-bottom: 10px;
      min-height: 56px; display:flex; align-items:center; justify-content:center; text-align:center;
      font-weight: 900; line-height: 1.2; color:#0b1220; cursor: pointer; user-select: none;
      transition: transform .05s ease, filter .2s ease, opacity .2s ease;
    }
    .course.general{ background: var(--tag-general); color:#fff; }
    .course.licenciatura{ background: var(--tag-licenciatura); color:#fff; }
    .course.especialidad{ background: var(--tag-especialidad); color:#fff; }

    .course.blocked { filter: grayscale(0.75) brightness(0.75); opacity: .7; cursor: not-allowed; }
.show-auth .course.blocked{ cursor: pointer; opacity:.9; filter: grayscale(.35) brightness(.95); }
.course.blocked::after{
  content: "Bloqueado"; position:absolute; right:8px; top:8px;
  background:#0b1220; color:#fff; font-size:11px; padding:2px 8px; border-radius:999px; opacity:.8;
}
.show-auth .course.blocked::after{
  content: "Autorizar"; background:#fbbf24; color:#0b1220; opacity:1;
}
.course.authorized::after{
  content:"Autorizado"; position:absolute; right:8px; top:8px; background:#fde68a; color:#92400e;
  font-size:11px; padding:2px 8px; border-radius:999px; opacity:1;
}
    .course.blocked::after{
      content: "Bloqueado"; position:absolute; right:8px; top:8px;
      background:#0b1220; color:#fff; font-size:11px; padding:2px 8px; border-radius:999px; opacity:.8;
    }
    .course.approved {
  outline: 3px solid #22d3ee; outline-offset: 2px;
  box-shadow: 0 0 0 2px rgba(255,255,255,.18) inset, 0 6px 14px rgba(0,0,0,.25);
  position: relative;
  opacity: .88;
}
.course.approved .t {
  text-decoration: line-through;
  text-decoration-thickness: 3px;
  text-underline-offset: 5px;
  opacity: .75;
}
.course.approved::before{
  content:"✓ Aprobado";
  position:absolute; left:10px; top:8px;
  background:#34d399; color:#0b1220;
  font-size:11px; font-weight:900;
  padding:2px 8px; border-radius:999px;
  box-shadow: 0 1px 3px rgba(0,0,0,.25);
}
    .course.approved .t { text-decoration: line-through; }

    .metrics { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px; margin: 12px 0; }
    .metric-card{ background: rgba(15,23,42,.7); border:1px solid #334155; border-radius: 16px; padding:12px; }
    .metric-title{ font-weight:800; color:#cbd5e1; margin-bottom: 8px; }
    .big { font-size: 28px; font-weight: 900; }
    .progress { width:100%; height:12px; background:#0b1220; border-radius:999px; border:1px solid #334155; overflow:hidden; }
    .bar { height:100%; width:0%; background: linear-gradient(90deg, #22d3ee, #60a5fa); }
    .bar.year1{ background: linear-gradient(90deg, var(--year1), #60a5fa); }
    .bar.year2{ background: linear-gradient(90deg, var(--year2), #a78bfa); }
    .bar.year3{ background: linear-gradient(90deg, var(--year3), #f59e0b); }

    .footer { padding: 18px; text-align:center; color:#cbd5e1; font-size: 12px; }
    /* Responsive tablet tweaks */
@media (max-width: 1200px){
  main{ max-width: 100vw; padding: 8px 10px calc(env(safe-area-inset-bottom) + 20px); }
  .tri-grid{ grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
  .tri-col{ padding: 10px; }
  .course{ padding: 12px; min-height: 58px; border-radius: 12px; }
}
@media (max-width: 820px){ /* tablets chicas / teléfonos grandes en vertical */
  header{ padding: calc(env(safe-area-inset-top) + 12px) 10px 6px; }
  h1{ font-size: clamp(20px, 6vw, 28px); }
  .subtitle{ font-size: clamp(12px, 3.3vw, 14px); }
  .toolbar{ gap:6px; }
  .tri-grid{ grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 10px; }
  .course{ padding: 10px; min-height: 54px; }
  .metric-card{ padding:10px; }
}
@media (max-width: 600px){ /* pantallas ~6" en vertical */
  .tri-grid{ grid-template-columns: 1fr; gap: 8px; }
  .course{ padding: 10px; min-height: 50px; }
  .year-title{ font-size: 14px; }
}
/* Evitar scroll horizontal y aprovechar ancho completo */
html, body{ max-width: 100vw; overflow-x: hidden; }
main{ width: 100%; }
/* Modal Felicitaciones (celebration upgrade) */
    .modal{ position: fixed; inset:0; background: rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index: 50; }
    .modal.open { display:flex; }
    .modal-card{
    background: radial-gradient(1200px 600px at 50% -20%, rgba(99,102,241,.25), transparent 40%),
                linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
    color:#eaf2ff;
    border:1px solid #364152;
    padding: 22px;
    border-radius: 22px;
    width:min(640px, 92vw);
    text-align:center;
    position: relative;
    box-shadow: 0 20px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.06);
    animation: celebrateIn .35s ease-out;
  }
  .cele-title{
    font-size: clamp(22px, 3.2vw, 34px);
    font-weight: 900;
    margin: 6px 0 10px;
    background: linear-gradient(90deg, #fcd34d, #f59e0b, #fda4af);
    -webkit-background-clip: text; background-clip: text; color: transparent;
    letter-spacing: .02em;
  }
  .cele-sub{
    font-size: clamp(15px, 1.9vw, 18px);
    line-height: 1.6;
    color:#dbeafe;
    margin: 6px 0 4px;
  }
  .cele-hr{ height:1px; background: linear-gradient(90deg, transparent, #334155, transparent); margin:12px 0; }
  .cele-emoji{ font-size: 38px; display:inline-block; animation: bob 2s ease-in-out infinite; }
  .cele-actions{ display:flex; justify-content:center; gap:12px; margin-top:14px; }
  .btnx{
    cursor:pointer; border:none; padding:12px 18px; min-width:120px; min-height:44px;
    border-radius:16px; font-weight:900; font-size:16px; box-shadow: 0 6px 16px rgba(0,0,0,.3);
    transition: transform .05s ease, filter .2s ease, box-shadow .2s ease;
    color:#0b1220; background:#fff;
  }
  .btnx.primary{ background:#34d399; }
  .btnx.secondary{ background:#93c5fd; }
  .btnx:active{ transform: translateY(1px); filter: brightness(.98); }
  @keyframes celebrateIn{ from{ transform: translateY(6px) scale(.98); opacity:0 } to{ transform:none; opacity:1 } }
  @keyframes bob{ 0%,100%{ transform: translateY(0) } 50%{ transform: translateY(-6px) } }
    .confetti-canvas{ position: fixed; inset:0; pointer-events:none; z-index:49; }
  .install-fab{
      position: fixed; right: 16px; bottom: calc(env(safe-area-inset-bottom) + 16px);
      z-index: 70; border-radius: 999px; padding: 14px 16px; min-height: 48px;
      font-weight: 900; box-shadow: 0 10px 24px rgba(0,0,0,.35);
      background:#34d399; color:#0b1220; border:none; display:none;
    }
    .install-fab.show{ display:inline-flex; align-items:center; gap:8px; }
    .install-fab:active{ transform: translateY(1px); }
    @media (max-width: 640px){ .install-fab{ right: 12px; bottom: calc(env(safe-area-inset-bottom) + 12px); } }
  </style>
</head>
<body>
  <canvas id="confetti" class="confetti-canvas" aria-hidden="true"></canvas>
  <header>
    <h1>Malla Curricular – Trabajo Social</h1>
    <p class="subtitle">Optimizada para tablet/Android · 8 trimestres · Sincrónicas 2×/semana + asincrónicas</p>
    <div class="toolbar">
      <div class="menu" id="menu">
        <button id="menuBtn" aria-haspopup="true" aria-expanded="false" aria-controls="menuPanel">Menú ▾</button>
        <div id="menuPanel" class="menu-panel" role="menu" aria-labelledby="menuBtn">
          <div class="menu-item">
            <span>Modo autorización</span>
            <label class="switch">
              <input id="authMode" type="checkbox" />
              <span class="knob"></span>
            </label>
          </div>
          
          
          <div class="menu-item" id="resetBtn"><span>Reiniciar todo</span><span class="btn" style="padding:6px 10px;">⟲</span></div>
          
        </div>
      </div>
      
      
    </div>
  </header>

  <main>
    <div class="legend always">
  <div class="legend-title">Leyenda de colores</div>
  <p class="legend-body">
    <span class="legend-pill"><span class="pill general"></span> General</span>
    <span class="legend-pill"><span class="pill licenciatura"></span> Licenciatura</span>
    <span class="legend-pill"><span class="pill especialidad"></span> Especialidad</span>
  </p>
</div>

    <section class="metrics" aria-live="polite">
      <div class="metric-card">
        <div class="metric-title">Progreso global</div>
        <div class="progress" aria-label="Progreso global"><div id="barGlobal" class="bar" style="width:0%"></div></div>
        <div class="big" id="pctGlobal">0%</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Progreso Año 1</div>
        <div class="progress"><div id="barY1" class="bar year1"></div></div>
        <div class="big" id="pctY1">0%</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Progreso Año 2</div>
        <div class="progress"><div id="barY2" class="bar year2"></div></div>
        <div class="big" id="pctY2">0%</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Progreso Año 3</div>
        <div class="progress"><div id="barY3" class="bar year3"></div></div>
        <div class="big" id="pctY3">0%</div>
      </div>
    </section>

    <div id="years"></div>
  </main>

  <div id="modalCongrats" class="modal" role="dialog" aria-modal="true" aria-labelledby="congratsTitle">
  <div class="modal-card">
    <div class="cele-emoji" aria-hidden="true">🎓✨</div>
    <h2 id="congratsTitle" class="cele-title">¡Meta Alcanzada!</h2>
    <div class="cele-hr"></div>
    <p class="cele-sub">
      Has completado <strong>toda tu malla curricular</strong> con éxito.<br/>
      Estás a un paso de convertirte oficialmente en <strong>Trabajador Social</strong>.
    </p>
    <p class="cele-sub">
      Que esta victoria sea el inicio de una carrera llena de logros, impacto positivo y orgullo.
      <br/><strong>¡Tu esfuerzo y constancia hoy brillan más que nunca!</strong>
    </p>
    <div class="cele-actions">
      <button id="closeCongrats" class="btnx primary">¡Gracias! 🎉</button>
      <button id="resetFromCongrats" class="btnx secondary">Reiniciar</button>
    </div>
  </div>
</div>

  <button id="installFab" class="install-fab">📲 Instalar app</button>
  <footer class="footer">App creada por Daniel Olave Valle · Agosto 2025</footer>

  <script>
// ----- Datos -----
const curriculum = [
  { year: 1, tri: 'T1', courses: [
    { title:'Fundamentos del Trabajo Social', tag:'Especialidad' },
    { title:'Antropología Cultural', tag:'General' },
    { title:'Economía y Sociedad', tag:'General' },
    { title:'Historia y Política Social de Chile', tag:'General' },
  ]},
  { year: 1, tri: 'T2', courses: [
    { title:'Fundamentos de la Intervención Social', tag:'Especialidad' },
    { title:'Teorías Sociológicas', tag:'General' },
    { title:'Psicología Social', tag:'General' },
    { title:'Justicia Social y Derechos Humanos', tag:'General' },
  ]},
  { year: 1, tri: 'T3', courses: [
    { title:'Enfoques y Estrategias de la Intervención Social', tag:'Especialidad' },
    { title:'Epistemología de las Ciencias Sociales', tag:'General' },
    { title:'Salud Mental', tag:'General' },
    { title:'Políticas Sociales', tag:'Especialidad' },
  ]},
  { year: 2, tri: 'T4', courses: [
    { title:'Trabajo Social con Personas y Familias', tag:'Especialidad' },
    { title:'Lógica de la Investigación Social', tag:'Licenciatura' },
    { title:'Pobreza y Exclusión Social', tag:'Especialidad' },
    { title:'Diseño de Proyectos Sociales', tag:'Especialidad' },
  ]},
  { year: 2, tri: 'T5', courses: [
    { title:'Trabajo Social con Organizaciones', tag:'Especialidad' },
    { title:'Investigación Social Cualitativa', tag:'Licenciatura' },
    { title:'Investigación Social Cuantitativa', tag:'Licenciatura' },
    { title:'Evaluación de Proyectos Sociales', tag:'Licenciatura' },
  ]},
  { year: 2, tri: 'T6', courses: [
    { title:'Trabajo Social y Desarrollo Local', tag:'Especialidad' },
    { title:'Análisis de los Datos Cualitativos', tag:'Licenciatura' },
    { title:'Análisis de los Datos Cuantitativos', tag:'Licenciatura' },
    { title:'Perspectivas Éticas en Trabajo Social', tag:'Especialidad' },
  ]},
  { year: 3, tri: 'T7', courses: [
    { title:'Módulo Integrador: Intervención Aplicada I', tag:'Especialidad' },
    { title:'Seminario de Título I', tag:'Licenciatura' },
    { title:'Análisis de Políticas Sociales', tag:'Especialidad' },
    { title:'Electivo I', tag:'Especialidad' },
  ]},
  { year: 3, tri: 'T8', courses: [
    { title:'Módulo Integrador: Intervención Aplicada II', tag:'Especialidad', prereq: 'Módulo Integrador: Intervención Aplicada I' },
    { title:'Seminario de Título II', tag:'Licenciatura', prereq: 'Seminario de Título I' },
    { title:'Gestión e Innovación de la Intervención Social', tag:'Especialidad' },
    { title:'Electivo II', tag:'Especialidad', prereq: 'Electivo I' },
  ]},
];;

// ----- Estado -----
const defaultState = {
  approvals: {},        // { courseId: boolean }
  auth: {},             // { courseId: boolean }
  bg: 'assets/bg-default.png'
};
const STATE_KEY = 'ts_malla_state_v1_3_3';
let state = loadState();

function slug(str){ return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function courseId(tri, title){ return slug(tri+'-'+title); }
function saveState(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
function loadState(){
  try{ const raw = localStorage.getItem(STATE_KEY); if(raw){ return { ...defaultState, ...JSON.parse(raw) }; } }catch(e){}
  return structuredClone(defaultState);
}

// Background swap support (fixed image)
function applyBackground(){
  const styleEl = document.getElementById('dynamic-bg') || (()=>{ const s=document.createElement('style'); s.id='dynamic-bg'; document.head.appendChild(s); return s; })();
  styleEl.textContent = `body::before{ background-image:url('${state.bg}'); }`;
}

const yearsContainer = document.getElementById('years');
function render(){
  yearsContainer.innerHTML = '';

  const triOrder = curriculum.map(s => s.tri);
  const triApprovedMap = {};
  for(const sec of curriculum){
    triApprovedMap[sec.tri] = sec.courses.every(c => !!state.approvals[courseId(sec.tri, c.title)]);
  }

  const mkYear = (label, tris) => {
    const y = document.createElement('div'); y.className='year-block';
    const title = document.createElement('div'); title.className='year-title'; title.textContent = label;
    y.appendChild(title);

    const grid = document.createElement('div'); grid.className='tri-grid';

    for(const tri of tris){
      const sec = curriculum.find(s => s.tri===tri);
      const col = document.createElement('div'); col.className='tri-col';
      const head = document.createElement('div'); head.className='tri-head'; head.textContent = tri.replace('T','Trimestre ');
      col.appendChild(head);

      const triIndex = triOrder.indexOf(tri);
      let unlockedByPrev = true;
      if(triIndex > 0){
        const prevTri = triOrder[triIndex - 1];
        unlockedByPrev = triApprovedMap[prevTri];
      }

      for(const c of sec.courses){
        const id = courseId(tri, c.title);
        const approved = !!state.approvals[id];
        const authorized = !!state.auth[id];

        // prereq check
        let blocked = !unlockedByPrev;
        if(c.prereq){
          const prereqTriIndex = curriculum.findIndex(s => s.courses.some(cc => cc.title === c.prereq));
          const prereqTri = prereqTriIndex>=0 ? curriculum[prereqTriIndex].tri : '';
          const prereqCourseId = courseId(prereqTri, c.prereq);
          const prereqApproved = !!state.approvals[prereqCourseId];
          if(!prereqApproved){ blocked = true; }
        }
        if(authorized){ blocked = false; }

        const div = document.createElement('div');
  div.className = `course ${c.tag.toLowerCase()} ${approved?'approved':''} ${blocked?'blocked':''} ${authorized?'authorized':''}`;
        div.setAttribute('role','button'); div.setAttribute('tabindex','0');
        div.setAttribute('aria-pressed', approved? 'true':'false');
        div.innerHTML = `<span class="t">${c.title}</span>`;

        function toggle(){
      const authEnabled = document.getElementById('authMode').checked;
      if(blocked){
        if(authEnabled){
          state.auth[id] = !authorized; // toggle per-course authorization
          saveState(); render();
        }
        return;
      }
      state.approvals[id] = !approved;
          saveState();
          render();
          checkCompletion();
        }
        div.addEventListener('click', toggle);
        div.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(); }});

        col.appendChild(div);
      }

      grid.appendChild(col);
    }

    y.appendChild(grid);
    yearsContainer.appendChild(y);
  };

  mkYear('PRIMER AÑO', ['T1','T2','T3']);
  mkYear('SEGUNDO AÑO', ['T4','T5','T6']);
  mkYear('TERCER AÑO', ['T7','T8']);

  updateProgress();
}

function updateProgress(){
  // compute progress by approvals
  let total=0, approved=0;
  const perYear = {1:{t:0,a:0},2:{t:0,a:0},3:{t:0,a:0}};
  for(const sec of curriculum){
    for(const c of sec.courses){
      const id = courseId(sec.tri, c.title);
      total++; if(state.approvals[id]) approved++;
      perYear[sec.year].t++; if(state.approvals[id]) perYear[sec.year].a++;
    }
  }
  const pct = total? Math.round(approved/total*100):0;
  document.getElementById('barGlobal').style.width = pct+'%';
  document.getElementById('pctGlobal').textContent = pct+'%';
  const yPcts = [
    perYear[1].t? Math.round(perYear[1].a/perYear[1].t*100):0,
    perYear[2].t? Math.round(perYear[2].a/perYear[2].t*100):0,
    perYear[3].t? Math.round(perYear[3].a/perYear[3].t*100):0,
  ];
  ['Y1','Y2','Y3'].forEach((k,i)=>{
    document.getElementById('bar'+k).style.width = yPcts[i]+'%';
    document.getElementById('pct'+k).textContent = yPcts[i]+'%';
  });
}

// Completion + confetti
function checkCompletion(){
  const all = curriculum.flatMap(sec => sec.courses.map(c => courseId(sec.tri, c.title)));
  const done = all.every(id => !!state.approvals[id]);
  const modal = document.getElementById('modalCongrats');
  if(done){ modal.classList.add('open'); runConfetti(); }
  else { modal.classList.remove('open'); stopConfetti(); }
}

let confettiAnim = null;
function runConfetti(){
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  let w = canvas.width = window.innerWidth;
  let h = canvas.height = window.innerHeight;
  const pieces = Array.from({length: 160}, () => ({
    x: Math.random()*w, y: Math.random()*-h, size: 6+Math.random()*8,
    speed: 1+Math.random()*3, angle: Math.random()*Math.PI*2,
  }));
  function onResize(){ w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
  window.addEventListener('resize', onResize);
  function draw(){
    ctx.clearRect(0,0,w,h);
    for(const p of pieces){
      p.y += p.speed; p.angle += 0.05;
      const s = p.size * (0.6 + 0.4*Math.sin(p.angle));
      ctx.fillStyle = ['#22d3ee','#60a5fa','#f59e0b','#10b981','#a78bfa'][Math.floor(Math.random()*5)];
      ctx.fillRect(p.x, p.y, s, s*0.6);
      if(p.y > h+20){ p.y = -20; p.x = Math.random()*w; }
    }
    confettiAnim = requestAnimationFrame(draw);
  }
  draw();
}
function stopConfetti(){ if(confettiAnim){ cancelAnimationFrame(confettiAnim); confettiAnim = null; } }

// Menu
function setupMenu(){
  const menu = document.getElementById('menu');
  const btn = document.getElementById('menuBtn');
  const panel = document.getElementById('menuPanel');
  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const open = menu.classList.toggle('open');
    btn.setAttribute('aria-expanded', open?'true':'false');
  });
  document.addEventListener('click', (e)=>{
    if(!menu.contains(e.target)){ menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  });

  // Auth mode
  const authMode = document.getElementById('authMode');
  authMode.checked = false;
  authMode.addEventListener('change', ()=>{
    document.body.classList.toggle('show-auth', authMode.checked);
  });

    
  // Reset
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(confirm('¿Seguro que deseas reiniciar todo?')){
      state = structuredClone(defaultState);
      saveState(); applyBackground(); render(); checkCompletion();
    }
  });

  // Congrats modal buttons
  document.getElementById('closeCongrats').addEventListener('click', ()=>{
    document.getElementById('modalCongrats').classList.remove('open'); stopConfetti();
  });
  document.getElementById('resetFromCongrats').addEventListener('click', ()=>{
    state = structuredClone(defaultState);
    saveState(); applyBackground(); render(); checkCompletion();
    document.getElementById('modalCongrats').classList.remove('open'); stopConfetti();
  });
}

// Service worker
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

applyBackground();
setupMenu();
render();
checkCompletion();

</script>
</body>
</html>
